<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©è¯»ä»»åŠ¡æ¿</title>
    <style>
        /* åŸºç¡€è®¾ç½® */
        html, body { margin: 0; padding: 0; height: 100%; background-color: #ffffff; overflow: hidden; font-family: 'Segoe UI', sans-serif;}

        /* æ»‘åŠ¨å®¹å™¨ */
        .slider-container {
            width: 100vw; height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .slider-container::-webkit-scrollbar { display: none; }

        /* æ¯ä¸€å± */
        .section {
            width: 100vw; height: 100vh;
            scroll-snap-align: start;
            position: relative;
            background: #ffffff; 
            display: flex; justify-content: center; align-items: center;
        }

        /* ç”»å¸ƒå®¹å™¨ */
        .canvas-scaler {
            width: 1000px; height: 562px;
            position: relative;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            overflow: hidden; 
        }

        /* å†…å®¹å±‚ */
        .content-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
        }

        /* é”å®šé®ç½© */
        .locked-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #555;
            border: 4px solid #dc3545; 
            box-sizing: border-box;
        }
        .timer { font-size: 6em; font-weight: bold; color: #dc3545; margin: 20px 0; font-family: monospace; }
        
        .hidden { display: none !important; }

        /* åŠ è½½æç¤ºé®ç½© */
        #global-loading-mask {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: white;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text-main { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .loading-text-sub { font-size: 1.2em; color: #888; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="global-loading-mask">
    <div class="loading-spinner"></div>
    <div class="loading-text-main">é»˜å†™ä»»åŠ¡æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å...</div>
    <div class="loading-text-sub">ä¸æ˜¯ç³»ç»Ÿé—®é¢˜ï¼Œæ­£åœ¨ä¸‹è½½å›¾ç‰‡èµ„æº</div>
</div>

<div class="slider-container">
    <div class="section">
        <div class="canvas-scaler">
            <div id="reading-content" class="content-layer"></div>
        </div>
    </div>

    <div class="section">
        <div class="canvas-scaler">
            <div id="dictation-content" class="content-layer hidden"></div>
            <div id="lock" class="locked-mask">
                <span style="font-size: 3em; font-weight:bold;">ğŸ”’ é»˜å†™æœªå¼€å¯</span>
                <!-- è¿™é‡Œæ˜¾ç¤ºå€’è®¡æ—¶ -->
                <div id="status-text" class="timer">--:--:--</div>
                <div style="font-size: 1.5em; color:#888;">
                    å¼€æ”¾æ—¶é—´: <span id="target-time" style="font-weight:bold; color:#333">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function resizeCanvas() {
        const scalers = document.querySelectorAll('.canvas-scaler');
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;
        const targetW = 1000;
        const targetH = 562;
        const scale = Math.min(screenW / targetW, screenH / targetH); 
        scalers.forEach(el => { el.style.transform = `scale(${scale})`; });
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    let isFirstLoad = true;

    function loadTask() {
        fetch('data.json?t=' + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                // 1. æ¸²æŸ“å†…å®¹
                const readingDiv = document.getElementById('reading-content');
                const dictationDiv = document.getElementById('dictation-content');
                
                // ä»…å½“å†…å®¹æœ‰å˜åŒ–æ‰é‡æ–°èµ‹å€¼HTMLï¼Œé¿å…é—ªçƒ
                if(readingDiv.innerHTML !== data.reading_html) readingDiv.innerHTML = data.reading_html || "";
                if(dictationDiv.innerHTML !== data.dictation_html) dictationDiv.innerHTML = data.dictation_html || "";
                
                document.getElementById('target-time').innerText = data.open_datetime ? data.open_datetime.replace('T', ' ') : "æœªè®¾å®š";
                
                // 2. å°†æ•°æ®ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›å®šæ—¶å™¨æ£€æŸ¥æ—¶é—´
                window.currentTaskData = data;
                
                // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æ—¶é—´
                checkTime();

                // 3. å›¾ç‰‡é¢„åŠ è½½é€»è¾‘
                if (isFirstLoad) {
                    const images = document.querySelectorAll('img');
                    const promises = Array.from(images).map(img => {
                        if (img.complete) return Promise.resolve();
                        return new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve;
                        });
                    });
                    Promise.all(promises).then(() => {
                        const mask = document.getElementById('global-loading-mask');
                        if(mask) mask.style.display = 'none';
                        isFirstLoad = false;
                    });
                    setTimeout(() => {
                        const mask = document.getElementById('global-loading-mask');
                        if(mask) mask.style.display = 'none';
                    }, 8000);
                }
            })
            .catch(err => console.error(err));
    }

    // === æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æœ¬æœºæ—¶é—´ ===
    function checkTime() {
        const data = window.currentTaskData;
        if (!data || !data.open_datetime) return;

        // è·å–æœ¬æœºå½“å‰æ—¶é—´
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        
        // æ ¼å¼åŒ–å½“å‰æ—¶é—´ä¸º YYYY-MM-DDTHH:mm
        const currentStr = 
            now.getFullYear() + "-" + 
            pad(now.getMonth() + 1) + "-" + 
            pad(now.getDate()) + "T" + 
            pad(now.getHours()) + ":" + 
            pad(now.getMinutes());

        // ç”¨äºæ˜¾ç¤ºçš„ç§’æ•°æ—¶é—´
        const displayTime = pad(now.getHours()) + ":" + pad(now.getMinutes()) + ":" + pad(now.getSeconds());

        const dictationDiv = document.getElementById('dictation-content');
        const lockDiv = document.getElementById('lock');
        const statusText = document.getElementById('status-text');

        // ç›´æ¥æ¯”è¾ƒå­—ç¬¦ä¸²
        if (currentStr >= data.open_datetime) {
            dictationDiv.classList.remove('hidden');
            lockDiv.classList.add('hidden');
        } else {
            dictationDiv.classList.add('hidden');
            lockDiv.classList.remove('hidden');
            // æ˜¾ç¤ºå¸¦ç§’æ•°çš„æ—¶é—´ï¼Œè®©å­¦ç”Ÿçœ‹åˆ°æ—¶é—´åœ¨èµ°
            statusText.innerText = displayTime; 
        }
    }

    loadTask();
    
    // ç½‘ç»œè¯·æ±‚ï¼šæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æœ‰æ²¡æœ‰æ–°ä»»åŠ¡ï¼ˆä¸ç”¨å¤ªé¢‘ç¹ï¼Œå‡è½»GitHubå‹åŠ›ï¼‰
    setInterval(loadTask, 10000);

    // æœ¬åœ°æ—¶é—´æ£€æŸ¥ï¼šæ¯1ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆä¿è¯å€’è®¡æ—¶ç²¾å‡†ï¼‰
    setInterval(checkTime, 1000);

</script>
</body>
</html>
