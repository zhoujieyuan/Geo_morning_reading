<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©è¯»ä»»åŠ¡æ¿</title>
    <style>
        /* åŸºç¡€è®¾ç½® */
        html, body { margin: 0; padding: 0; height: 100%; background-color: #ffffff; overflow: hidden; font-family: 'Segoe UI', sans-serif;}

        /* æ»‘åŠ¨å®¹å™¨ */
        .slider-container {
            width: 100vw; height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .slider-container::-webkit-scrollbar { display: none; }

        /* æ¯ä¸€å± */
        .section {
            width: 100vw; height: 100vh;
            scroll-snap-align: start;
            position: relative;
            background: #ffffff; 
            display: flex; justify-content: center; align-items: center;
        }

        /* ç”»å¸ƒå®¹å™¨ */
        .canvas-scaler {
            width: 1000px; height: 562px;
            position: relative;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            overflow: hidden; 
        }

        /* å†…å®¹å±‚ */
        .content-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
        }

        /* é”å®šé®ç½© */
        .locked-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #555;
            border: 4px solid #dc3545; 
            box-sizing: border-box;
        }
        .timer { font-size: 6em; font-weight: bold; color: #dc3545; margin: 20px 0; font-family: monospace; }
        
        .hidden { display: none !important; }

        /* === æ–°å¢ï¼šå…¨å±€åŠ è½½æç¤ºé®ç½© === */
        #global-loading-mask {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: white;
            z-index: 9999; /* æœ€é¡¶å±‚ */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text-main { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .loading-text-sub { font-size: 1.2em; color: #888; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- å…¨å±€åŠ è½½æç¤º -->
<div id="global-loading-mask">
    <div class="loading-spinner"></div>
    <div class="loading-text-main">é»˜å†™ä»»åŠ¡æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å...</div>
    <div class="loading-text-sub">ä¸æ˜¯ç³»ç»Ÿé—®é¢˜ï¼Œæ­£åœ¨ä¸‹è½½å›¾ç‰‡èµ„æº</div>
</div>

<div class="slider-container">
    <!-- ç¬¬ä¸€å±ï¼šæ—©è¯» -->
    <div class="section">
        <div class="canvas-scaler">
            <div id="reading-content" class="content-layer"></div>
        </div>
        <!-- ç®­å¤´å·²åˆ é™¤ -->
    </div>

    <!-- ç¬¬äºŒå±ï¼šé»˜å†™ -->
    <div class="section">
        <div class="canvas-scaler">
            <div id="dictation-content" class="content-layer hidden"></div>
            <div id="lock" class="locked-mask">
                <span style="font-size: 3em; font-weight:bold;">ğŸ”’ é»˜å†™æœªå¼€å¯</span>
                <div id="status-text" class="timer">--:--</div>
                <div style="font-size: 1.5em; color:#888;">
                    å¼€æ”¾æ—¶é—´: <span id="target-time" style="font-weight:bold; color:#333">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ç¼©æ”¾é€»è¾‘
    function resizeCanvas() {
        const scalers = document.querySelectorAll('.canvas-scaler');
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;
        const targetW = 1000;
        const targetH = 562;
        const scale = Math.min(screenW / targetW, screenH / targetH); 
        scalers.forEach(el => { el.style.transform = `scale(${scale})`; });
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); 

    // === æ ¸å¿ƒä¿®æ”¹ï¼šç­‰å¾…å›¾ç‰‡åŠ è½½é€»è¾‘ ===
    let isFirstLoad = true; // åªæœ‰ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºå¤§é®ç½©

    function loadTask() {
        fetch('data.json?t=' + new Date().getTime())
            .then(res => {
                const serverDateStr = res.headers.get('Date');
                const serverTime = serverDateStr ? new Date(serverDateStr) : new Date();
                return res.json().then(data => ({ data, serverTime }));
            })
            .then(({ data, serverTime }) => {
                const readingDiv = document.getElementById('reading-content');
                const dictationDiv = document.getElementById('dictation-content');

                // åªæœ‰å½“å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œæ‰å»æ¸²æŸ“
                // ä¸ºäº†ç®€å•ç¨³å¥ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½æ›´æ–° HTMLï¼Œä½†ç”¨ Promise ç­‰å¾…å›¾ç‰‡
                readingDiv.innerHTML = data.reading_html || "";
                dictationDiv.innerHTML = data.dictation_html || "";
                
                document.getElementById('target-time').innerText = data.open_datetime ? data.open_datetime.replace('T', ' ') : "æœªè®¾å®š";
                
                // æ£€æŸ¥æ—¶é—´é€»è¾‘
                checkTime(data, serverTime);

                // === ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ ===
                if (isFirstLoad) {
                    const images = document.querySelectorAll('img');
                    const promises = Array.from(images).map(img => {
                        if (img.complete) return Promise.resolve();
                        return new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve; // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿç»§ç»­ï¼Œé˜²æ­¢å¡æ­»
                        });
                    });

                    // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œåï¼Œéšè—é®ç½©
                    Promise.all(promises).then(() => {
                        const mask = document.getElementById('global-loading-mask');
                        if(mask) mask.style.display = 'none';
                        isFirstLoad = false;
                    });
                    
                    // è®¾ç½®ä¸€ä¸ªè¶…æ—¶å…œåº•ï¼Œå¦‚æœ10ç§’è¿˜æ²¡å¥½ï¼ˆæ¯”å¦‚ç½‘æ–­äº†ï¼‰ï¼Œå¼ºåˆ¶ç§»é™¤é®ç½©
                    setTimeout(() => {
                        const mask = document.getElementById('global-loading-mask');
                        if(mask) mask.style.display = 'none';
                    }, 10000);
                }
            })
            .catch(err => console.error(err));
    }

    function checkTime(data, serverTime) {
        if (!data.open_datetime) return;
        let beijingTime = new Date(serverTime.getTime() + 8 * 60 * 60 * 1000);
        const pad = n => n.toString().padStart(2, '0');
        const currentStr = 
            beijingTime.getUTCFullYear() + "-" + 
            pad(beijingTime.getUTCMonth() + 1) + "-" + 
            pad(beijingTime.getUTCDate()) + "T" + 
            pad(beijingTime.getUTCHours()) + ":" + 
            pad(beijingTime.getUTCMinutes());

        const dictationDiv = document.getElementById('dictation-content');
        const lockDiv = document.getElementById('lock');
        const statusText = document.getElementById('status-text');

        if (currentStr >= data.open_datetime) {
            dictationDiv.classList.remove('hidden');
            lockDiv.classList.add('hidden');
        } else {
            dictationDiv.classList.add('hidden');
            lockDiv.classList.remove('hidden');
            statusText.innerText = currentStr.replace('T', ' '); 
        }
    }

    loadTask();
    // ä¹‹åæ¯5ç§’é™é»˜åˆ·æ–°ï¼ˆä¸å†æ˜¾ç¤ºé®ç½©ï¼‰
    setInterval(loadTask, 5000);
</script>
</body>
</html>
