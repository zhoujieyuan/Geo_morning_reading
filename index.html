<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©è¯»ä»»åŠ¡æ¿</title>
    <style>
        /* ä¿æŒä¹‹å‰çš„å…¨å±æ»šåŠ¨æ ·å¼ */
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background-color: #f0f2f5; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        .section { height: 100vh; width: 100%; box-sizing: border-box; padding: 40px 60px; scroll-snap-align: start; display: flex; flex-direction: column; position: relative; }
        .section-reading { background-color: #fff; border-bottom: 5px solid #007bff; }
        .section-dictation { background-color: #fff; border-top: 5px solid #dc3545; }
        h2 { font-size: 2.5em; margin: 0 0 30px 0; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .section-reading h2 { color: #007bff; border-color: #007bff; }
        .section-dictation h2 { color: #dc3545; border-color: #dc3545; }
        .content { font-size: 2em; line-height: 1.6; color: #333; white-space: pre-wrap; flex: 1; overflow-y: auto; }
        .locked-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #fafafa; border: 4px dashed #ddd; border-radius: 20px; color: #888; }
        .timer { font-size: 4em; font-weight: bold; color: #dc3545; margin: 20px 0; }
        .server-time-tag { font-size: 0.4em; background: #eee; padding: 5px 15px; border-radius: 20px; vertical-align: middle; color: #666; font-weight: normal; margin-left: 20px; }
        .hidden { display: none !important; }
        .arrow-down { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 2em; color: #ccc; animation: bounce 2s infinite; cursor: pointer; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);} 40% {transform: translateX(-50%) translateY(-10px);} 60% {transform: translateX(-50%) translateY(-5px);} }
    </style>
</head>
<body>

    <!-- ç¬¬ä¸€å± -->
    <div class="section section-reading">
        <h2>ğŸ“– æ—©è¯»ä»»åŠ¡</h2>
        <div id="reading" class="content">æ­£åœ¨è¿æ¥æœåŠ¡å™¨è·å–ä»»åŠ¡...</div>
        <div class="arrow-down" onclick="window.scrollTo(0, window.innerHeight)">â¬‡ï¸ é»˜å†™åœ¨ä¸‹é¢</div>
    </div>

    <!-- ç¬¬äºŒå± -->
    <div class="section section-dictation">
        <h2>
            âœï¸ é»˜å†™ä»»åŠ¡ 
            <span class="server-time-tag">ğŸ•’ ç½‘ç»œæ—¶é—´ç®¡æ§ä¸­</span>
        </h2>
        
        <div id="dictation" class="content hidden"></div>

        <div id="lock" class="locked-area">
            <span style="font-size: 2em;">ğŸ”’ ä»»åŠ¡é”å®šä¸­</span>
            <div id="status-text" class="timer">--/-- --:--</div>
            <div style="font-size: 1.2em">
                å¼€æ”¾æ—¶é—´: <span id="target-time" style="font-weight:bold; color:#333">--</span>
            </div>
            <div style="font-size: 1em; color: #aaa; margin-top: 10px;">(ä¿®æ”¹æœ¬æœºæ—¶é—´æ— æ•ˆ)</div>
        </div>
    </div>

    <script>
        function loadTask() {
            fetch('data.json?t=' + new Date().getTime())
                .then(response => {
                    const serverDateStr = response.headers.get('Date');
                    if (!serverDateStr) throw new Error("æ— æ³•è·å–æœåŠ¡å™¨æ—¶é—´");
                    const serverTime = new Date(serverDateStr);
                    return response.json().then(data => ({ data, serverTime }));
                })
                .then(({ data, serverTime }) => {
                    document.getElementById('reading').innerText = data.reading;
                    // æ˜¾ç¤ºç›®æ ‡æ—¶é—´ (æŠŠ T æ¢æˆ ç©ºæ ¼ï¼Œå¥½çœ‹ç‚¹)
                    document.getElementById('target-time').innerText = data.open_datetime ? data.open_datetime.replace('T', ' ') : "æœªè®¾å®š";
                    checkTime(data, serverTime);
                })
                .catch(err => console.error("åŠ è½½ä¸­...", err));
        }

        function checkTime(data, serverTime) {
            if (!data.open_datetime) return; // å¦‚æœæ²¡è®¾æ—¶é—´ï¼Œé»˜è®¤é”å®š

            // 1. è®¡ç®—ã€å½“å‰æœåŠ¡å™¨çš„åŒ—äº¬æ—¶é—´ã€‘å­—ç¬¦ä¸²
            // æœåŠ¡å™¨æ˜¯ GMTï¼Œæˆ‘ä»¬è¦åŠ  8 å°æ—¶
            let beijingTime = new Date(serverTime.getTime() + 8 * 60 * 60 * 1000);
            
            // æ ¼å¼åŒ–æˆ YYYY-MM-DDTHH:mm è¿™ç§æ ‡å‡†æ ¼å¼ï¼Œæ–¹ä¾¿å­—ç¬¦ä¸²æ¯”è¾ƒ
            // æ³¨æ„ï¼štoISOString ä¼šå‡å› 8 å°æ—¶æ˜¾ç¤º UTCï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æ‹¼å­—ç¬¦ä¸²æœ€ç¨³
            const pad = n => n.toString().padStart(2, '0');
            const currentStr = 
                beijingTime.getUTCFullYear() + "-" + 
                pad(beijingTime.getUTCMonth() + 1) + "-" + 
                pad(beijingTime.getUTCDate()) + "T" + 
                pad(beijingTime.getUTCHours()) + ":" + 
                pad(beijingTime.getUTCMinutes());

            // 2. è·å–ã€è®¾å®šçš„ç›®æ ‡æ—¶é—´ã€‘å­—ç¬¦ä¸²
            const targetStr = data.open_datetime;

            const dictationDiv = document.getElementById('dictation');
            const lockDiv = document.getElementById('lock');
            const statusText = document.getElementById('status-text');

            // 3. æ ¸å¿ƒæ¯”è¾ƒï¼šå­—ç¬¦ä¸²ç›´æ¥æ¯”å¤§å° (ä¾‹å¦‚ "2023-10-27T08:00" > "2023-10-26T20:00")
            if (currentStr >= targetStr) {
                dictationDiv.innerText = data.dictation;
                dictationDiv.classList.remove('hidden');
                lockDiv.classList.add('hidden');
            } else {
                dictationDiv.classList.add('hidden');
                lockDiv.classList.remove('hidden');
                // æ˜¾ç¤ºå½“å‰æœåŠ¡å™¨æ—¥æœŸå’Œæ—¶é—´
                statusText.innerText = currentStr.replace('T', ' '); 
            }
        }

        loadTask();
        setInterval(loadTask, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>
